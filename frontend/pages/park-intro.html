<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›­åŒºåˆ†å¸ƒåœ°å›¾</title>
    <link rel="stylesheet" href="/web/assets/css/common.css" />
    <script src="https://webapi.amap.com/maps?v=2.0&key=2fa17571ada12cb8cb22fd2327235834"></script>
    <script src="https://webapi.amap.com/ui/1.1/main.js"></script>
    <style>
        /* åŸºç¡€å¸ƒå±€æ ·å¼ */
        .content { padding: 20px; height: calc(100vh - 80px); box-sizing: border-box; }
        .map-header { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; }
        .map-title { font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 8px; }
        .map-desc { font-size: 14px; color: #6b7280; line-height: 1.5; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px; color: #666; z-index: 999; }
        #mapContainer { width: 100%; height: calc(100% - 60px); border-radius: 8px; border: 1px solid #e5e7eb; position: relative; }

        /* åœ°å›¾ä¿¡æ¯çª—å£æ ·å¼ */
        .amap-info-window { padding: 0 !important; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-width: 280px; }
        .park-info { padding: 12px 16px; }
        .park-name { font-size: 16px; font-weight: bold; color: #2c6e31; margin-bottom: 6px; }
        .park-desc { font-size: 12px; color: #666; line-height: 1.4; margin-bottom: 10px; }

        /* æŒ‰é’®å®¹å™¨ä¸æŒ‰é’®æ ·å¼ - ç¡®ä¿ä¸¤ä¸ªæŒ‰é’®å¹¶åˆ— */
        .btn-group { display: flex; gap: 8px; align-items: center; }
        .park-detail-btn {
            display: inline-block; padding: 6px 12px;
            background: #2c6e31; color: white; font-size: 12px;
            border-radius: 4px; transition: background 0.2s;
            border: none; cursor: pointer;
        }
        .park-detail-btn:hover { background: #1f4e23; }
        .park-reserve-btn {
            display: inline-block; padding: 6px 12px;
            background: #008B8B; color: white; font-size: 12px;
            border-radius: 4px; transition: background 0.2s;
            border: none; cursor: pointer;
        }
        .park-reserve-btn:hover { background: #00CED1; }

        /* è¯¦æƒ…å¼¹çª—æ ·å¼ */
        .park-detail-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center;
            z-index: 9999; padding: 20px;
        }
        .park-detail-content {
            background: white; width: 90%; max-width: 800px;
            max-height: 90vh; overflow-y: auto; border-radius: 12px;
            padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
        }
        .close-modal {
            position: absolute; top: 20px; right: 20px;
            font-size: 20px; cursor: pointer; color: #666;
        }
        .close-modal:hover { color: #000; }
        .error-tip {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); text-align: center;
            color: #dc2626; font-size: 14px; padding: 20px;
        }

        /* é¢„çº¦è¡¨å•æ ·å¼ï¼ˆå…¨ç»¿è‰²ç³»ï¼‰ */
        .reservation-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center;
            z-index: 99999; padding: 20px;
        }
        .reservation-content {
            background: white; width: 90%; max-width: 700px;
            border-radius: 12px; padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: relative;
        }
        .reservation-form-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 16px; margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .reservation-form-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .reservation-form-grid { grid-template-columns: 1fr; }
        }
        .form-label {
            display: block; margin-bottom: 4px;
            font-size: 14px; color: #333;
        }
        .form-input {
            width: 100%; padding: 8px 12px;
            border: 1px solid #ddd; border-radius: 4px;
            font-size: 14px;
        }
        .form-input:focus {
            outline: none; border-color: #2c6e31;
        }
        .submit-btn {
            width: 100%; padding: 10px;
            background: #2c6e31; color: white;
            border: none; border-radius: 4px;
            cursor: pointer; font-size: 16px;
            margin-top: 10px; transition: background 0.2s;
        }
        .submit-btn:hover {
            background: #1f4e23;
        }
        /* æ–°å¢ï¼šæ˜¾ç¤ºé¢„çº¦åŒºåŸŸIDçš„æç¤ºæ ·å¼ */
        .resv-area-id-tip {
            font-size: 12px; color: #2c6e31;
            margin-bottom: 15px; text-align: center;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <aside id="sidebar" class="sidebar"></aside>
        <div class="main">
            <header id="header" class="header"></header>
            <main class="content container">
                <div class="map-header">
                    <h1 class="map-title">ğŸŒ² å›½å®¶å…¬å›­åˆ†å¸ƒåœ°å›¾</h1>
                    <p class="map-desc">
                        æœ¬åœ°å›¾å±•ç¤ºå…¨å›½é‡ç‚¹å›½å®¶çº§å…¬å›­åŠç”Ÿæ€åŒºçš„åœ°ç†åˆ†å¸ƒï¼Œç‚¹å‡»æ ‡è®°å¯æŸ¥çœ‹å…¬å›­ç®€ä»‹ï¼Œ
                        ç‚¹å‡»ã€ŒæŸ¥çœ‹è¯¦æƒ…ã€å¯äº†è§£è¯¥å…¬å›­çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå«å¼€æ”¾æ—¶é—´ã€äº¤é€šæŒ‡å—ã€æ¸¸å®¢é¡»çŸ¥ç­‰ï¼‰ã€‚
                    </p>
                </div>
                <div id="mapContainer">
                    <div class="loading" id="loadingTip">æ­£åœ¨åŠ è½½å›­åŒºæ•°æ®...</div>
                    <div class="error-tip" id="errorTip" style="display: none;">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
                </div>
            </main>
        </div>
    </div>

    <!-- å…¬å›­è¯¦æƒ…å¼¹çª—ï¼ˆä»…å±•ç¤ºè¯¦æƒ…ï¼Œæ— ä»»ä½•æŒ‰é’®ï¼‰ -->
    <div class="park-detail-modal" id="parkDetailModal">
        <div class="park-detail-content">
            <span class="close-modal" onclick="closeParkDetail()">Ã—</span>
            <div id="parkDetailContent"></div>
        </div>
    </div>

    <!-- é¢„çº¦è¡¨å•å¼¹çª—ï¼ˆç»¿è‰²æ ·å¼ï¼Œæ˜¾ç¤ºåŒºåŸŸIDï¼‰ -->
    <div class="reservation-modal" id="reservationModal">
        <div class="reservation-content">
            <span class="close-modal" onclick="closeReservationModal()">Ã—</span>
            <h2 style="color: #2c6e31; margin-bottom: 10px; text-align: center;">é¢„çº¦å…¥å›­</h2>
            <!-- æ˜¾ç¤ºå½“å‰é¢„çº¦çš„åŒºåŸŸID -->
            <div class="resv-area-id-tip" id="resvAreaIdTip">é¢„çº¦åŒºåŸŸIDï¼š<span id="showAreaId">0</span></div>
            <!-- éšè—çš„åŒºåŸŸIDå­—æ®µ -->
            <input type="hidden" id="resvAreaId" value="">

            <div class="reservation-form-grid">
                <div>
                    <label class="form-label">é¢„çº¦äººå§“å *</label>
                    <input type="text" id="resvName" class="form-input" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                <div>
                    <label class="form-label">èº«ä»½è¯å· *</label>
                    <input type="text" id="resvIdCard" class="form-input" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·">
                </div>
                <div>
                    <label class="form-label">è”ç³»ç”µè¯</label>
                    <input type="tel" id="resvPhone" class="form-input" placeholder="é€‰å¡«">
                </div>
                <div>
                    <label class="form-label">é¢„çº¦æ—¥æœŸ *</label>
                    <input type="date" id="resvDate" class="form-input">
                </div>
                <div>
                    <label class="form-label">é¢„çº¦æ—¶æ®µ *</label>
                    <select id="resvTimeSlot" class="form-input">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="ä¸Šåˆ">ä¸Šåˆ</option>
                        <option value="ä¸‹åˆ">ä¸‹åˆ</option>
                        <option value="å…¨å¤©">å…¨å¤©</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">é¢„çº¦äººæ•° *</label>
                    <!-- ä¿®å¤ï¼šä¿®æ­£IDé”™è¯¯ï¼Œä»resvIdCardæ”¹ä¸ºresvPeople -->
                    <input type="number" id="resvPeople" class="form-input" min="1" value="1">
                </div>
            </div>

            <button class="submit-btn" onclick="submitReservation()">æäº¤é¢„çº¦</button>
        </div>
    </div>

    <script src="/web/assets/js/api.js"></script>
    <script src="/web/assets/js/auth.js"></script>
    <script src="/web/assets/js/common.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let parkDataList = [];

        // APIè¯·æ±‚å°è£…
                // APIè¯·æ±‚å°è£…ï¼ˆå¢å¼ºé”™è¯¯å¤„ç†ï¼‰
        async function requestApi(url, method = 'GET', data = {}) {
            try {
                const token = localStorage.getItem('token') || (typeof Auth !== 'undefined' ? Auth.getToken() : '');
                // æ— tokenæ—¶å…ˆæç¤ºç™»å½•
                if (!token) {
                    alert('è¯·å…ˆç™»å½•ï¼');
                    window.location.href = '/web/pages/login.html';
                    throw new Error('æœªç™»å½•');
                }

                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
                const options = { method, headers };
                if (method !== 'GET' && Object.keys(data).length > 0) {
                    options.body = JSON.stringify(data);
                }

                // ä¿®å¤URLæ‹¼æ¥ï¼ˆç¡®ä¿æ˜¯ /api/visitor/reservationsï¼‰
                const fullUrl = `/api/visitor${url}`;
                const response = await fetch(fullUrl, options);

                // è§£æåç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯ï¼ˆå…³é”®ï¼‰
                let responseData;
                try {
                    responseData = await response.json();
                } catch (e) {
                    responseData = { detail: 'æœåŠ¡å™¨è¿”å›éJSONæ•°æ®' };
                }

                if (!response.ok) {
                    // æŠ›å‡ºåŒ…å«åç«¯è¯¦ç»†é”™è¯¯çš„å¼‚å¸¸
                    throw new Error(`${response.status} ${response.statusText}ï¼š${responseData.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
                return responseData;
            } catch (error) {
                console.error('APIè¯·æ±‚é”™è¯¯ï¼š', error);
                throw error;
            }
        }

        // åˆå§‹åŒ–åœ°å›¾
        window.onload = async function() {
            try {
                document.getElementById('errorTip').style.display = 'none';
                document.getElementById('loadingTip').style.display = 'block';

                // åˆå§‹åŒ–é«˜å¾·åœ°å›¾
                map = new AMap.Map('mapContainer', {
                    zoom: 4,
                    center: [108.95, 34.27],
                    resizeEnable: true,
                    showLabel: true,
                    mapStyle: 'amap://styles/grassgreen'
                });

                // è·å–å›­åŒºæ•°æ®
                parkDataList = await requestApi('/areas');
                document.getElementById('loadingTip').style.display = 'none';

                // æ— æ•°æ®å¤„ç†
                if (parkDataList.length === 0) {
                    document.getElementById('errorTip').innerText = 'æš‚æ— å›­åŒºæ•°æ®';
                    document.getElementById('errorTip').style.display = 'block';
                    return;
                }

                // æ¸²æŸ“å›­åŒºæ ‡è®°
                parkDataList.forEach(park => {
                    if (!park.longitude || !park.latitude) {
                        console.warn(`å›­åŒºã€${park.area_name}ã€‘ç»çº¬åº¦ç¼ºå¤±ï¼Œè·³è¿‡æ ‡è®°`);
                        return;
                    }
                    // åˆ›å»ºæ ‡è®°
                    const marker = new AMap.Marker({
                        position: [park.longitude, park.latitude],
                        title: park.area_name,
                        map: map,
                        content: '<div style="font-size: 20px; line-height: 1;">ğŸ“</div>',
                        offset: new AMap.Pixel(-16, -16)
                    });

                    // åˆ›å»ºä¿¡æ¯çª—å£ï¼ˆä¸¤ä¸ªæŒ‰é’®å¹¶åˆ—ï¼‰
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div class="park-info">
                                <div class="park-name">${park.area_name || 'æœªçŸ¥å›­åŒº'}</div>
                                <div class="park-desc">${park.protect_rules || `(${park.area_type}ï¼Œé¢ç§¯${park.area_size}å…¬é¡·)`}</div>
                                <div class="btn-group">
                                    <button onclick="openParkDetail(${park.area_id})" class="park-detail-btn">æŸ¥çœ‹è¯¦æƒ…</button>
                                    <button onclick="openReservationModal(${park.area_id})" class="park-reserve-btn">é¢„çº¦å…¥å›­</button>
                                </div>
                            </div>
                        `,
                        offset: new AMap.Pixel(0, -40)
                    });

                    // æ ‡è®°ç‚¹å‡»äº‹ä»¶ï¼šæ‰“å¼€ä¿¡æ¯çª—å£
                    marker.on('click', () => {
                        infoWindow.open(map, marker.getPosition());
                    });

                    // é¼ æ ‡æ‚¬æµ®äº‹ä»¶ï¼šæ”¾å¤§åœ°å›¾
                    marker.on('mouseover', () => {
                        map.setZoomAndCenter(8, [park.longitude, park.latitude]);
                    });
                });

                // æ·»åŠ åœ°å›¾æ§ä»¶
                map.addControl(new AMap.Scale());
                map.addControl(new AMap.Zoom());
                map.addControl(new AMap.MapType({ defaultType: 0 }));
                map.addControl(new AMap.Geolocation({ enableHighAccuracy: true }));
            } catch (error) {
                document.getElementById('loadingTip').style.display = 'none';
                document.getElementById('errorTip').style.display = 'block';
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼š', error);
            }
        };

        // æ‰“å¼€è¯¦æƒ…å¼¹çª—ï¼ˆä»…å±•ç¤ºè¯¦æƒ…ï¼Œæ— æŒ‰é’®ï¼‰
        async function openParkDetail(areaId) {
            try {
                document.getElementById('parkDetailContent').innerHTML = '<div style="text-align:center; padding: 20px;">æ­£åœ¨åŠ è½½è¯¦æƒ…...</div>';
                document.getElementById('parkDetailModal').style.display = 'flex';

                // è·å–å›­åŒºè¯¦æƒ…
                const parkDetail = await requestApi(`/areas/${areaId}`);

                // æ„å»ºè¯¦æƒ…HTMLï¼ˆçº¯ä¿¡æ¯å±•ç¤ºï¼‰
                const detailHtml = `
                    <h2 style="color: #2c6e31; margin-bottom: 16px;">${parkDetail.area_name || 'æœªçŸ¥å›­åŒº'}</h2>
                    <div style="margin-bottom: 20px; line-height: 1.6;">
                        <p><strong>ç”Ÿæ€ç±»å‹ï¼š</strong>${parkDetail.area_type || 'æœªå®šä¹‰'}</p>
                        <p><strong>é¢ç§¯ï¼š</strong>${parkDetail.area_size || '0'} å…¬é¡·</p>
                        <p><strong>æ ¸å¿ƒä¿æŠ¤èŒƒå›´ï¼š</strong>${parkDetail.protect_rules || 'æš‚æ— æè¿°'}</p>
                        <p><strong>ç¯å¢ƒé€‚å®œæ€§è¯„åˆ†ï¼š</strong>${parkDetail.score || '0'}</p>
                    </div>
                    <h3 style="margin: 20px 0 10px; color: #1f2937;">åœ°ç†ä½ç½®</h3>
                    <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>ç»åº¦ï¼š</strong>${parkDetail.longitude || '0'}</p>
                        <p><strong>çº¬åº¦ï¼š</strong>${parkDetail.latitude || '0'}</p>
                    </div>
                    <h3 style="margin: 20px 0 10px; color: #1f2937;">æ¸¸å®¢é¡»çŸ¥</h3>
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                        <p>1. è¿›å…¥å›­åŒºè¯·éµå®ˆç›¸å…³è§„å®šï¼Œä¿æŠ¤ç”Ÿæ€ç¯å¢ƒ</p>
                        <p>2. ${parkDetail.area_type === 'æ ¸å¿ƒä¿æŠ¤åŒº' ? 'æ ¸å¿ƒä¿æŠ¤åŒºç¦æ­¢æ¸¸å®¢è¿›å…¥' : 'è¯·æŒ‰æŒ‡å®šè·¯çº¿æ¸¸è§ˆï¼Œç¦æ­¢è¿›å…¥æœªå¼€æ”¾åŒºåŸŸ'}</p>
                        <p>3. ç¦æ­¢æºå¸¦ç«ç§è¿›å…¥æ—åŒºï¼Œä¸¥é˜²æ£®æ—ç«ç¾</p>
                        <p>4. ç¦æ­¢æŠ•å–‚ã€ä¼¤å®³é‡ç”ŸåŠ¨ç‰©</p>
                    </div>
                `;

                document.getElementById('parkDetailContent').innerHTML = detailHtml;
            } catch (error) {
                // é”™è¯¯é¡µé¢ä»…æ˜¾ç¤ºé‡è¯•æŒ‰é’®
                document.getElementById('parkDetailContent').innerHTML = `
                    <div style="text-align:center; color: #dc2626; padding: 20px;">
                        <p>è¯¦æƒ…åŠ è½½å¤±è´¥</p>
                        <button onclick="openParkDetail(${areaId})" class="park-detail-btn">é‡è¯•</button>
                    </div>
                `;
                console.error('è·å–å›­åŒºè¯¦æƒ…å¤±è´¥ï¼š', error);
            }
        }

        // å…³é—­è¯¦æƒ…å¼¹çª—
        function closeParkDetail() {
            document.getElementById('parkDetailModal').style.display = 'none';
        }

        // æ‰“å¼€é¢„çº¦è¡¨å•å¼¹çª—ï¼ˆå…³è”åŒºåŸŸIDï¼‰
        function openReservationModal(areaId) {
            // å¡«å……å¹¶æ˜¾ç¤ºåŒºåŸŸID
            document.getElementById('resvAreaId').value = areaId;
            document.getElementById('showAreaId').innerText = areaId;

            // é‡ç½®è¡¨å•
            document.getElementById('resvName').value = '';
            document.getElementById('resvIdCard').value = '';
            document.getElementById('resvPhone').value = '';
            document.getElementById('resvDate').value = '';
            document.getElementById('resvTimeSlot').value = '';
            document.getElementById('resvPeople').value = '1';

            // æ‰“å¼€é¢„çº¦å¼¹çª—
            document.getElementById('reservationModal').style.display = 'flex';

            // å…³é—­è¯¦æƒ…å¼¹çª—ï¼ˆé¿å…é®æŒ¡ï¼‰
            closeParkDetail();
        }

        // å…³é—­é¢„çº¦è¡¨å•å¼¹çª—
        function closeReservationModal() {
            document.getElementById('reservationModal').style.display = 'none';
        }

        // æäº¤é¢„çº¦ï¼ˆä¼ é€’åŒºåŸŸIDåˆ°åç«¯ï¼‰
                // æäº¤é¢„çº¦ï¼ˆä¼ é€’åŒºåŸŸIDåˆ°åç«¯ï¼‰
        async function submitReservation() {
            // è·å–è¡¨å•æ•°æ®
            const areaId = document.getElementById('resvAreaId').value;
            const name = document.getElementById('resvName').value.trim();
            const idCard = document.getElementById('resvIdCard').value.trim();
            const phone = document.getElementById('resvPhone').value.trim();
            const date = document.getElementById('resvDate').value;
            const timeSlot = document.getElementById('resvTimeSlot').value;
            const people = document.getElementById('resvPeople').value;

            // è¡¨å•æ ¡éªŒï¼ˆå¢å¼ºç‰ˆï¼‰
            if (!name) { alert('è¯·å¡«å†™é¢„çº¦äººå§“åï¼'); return; }
            if (!idCard) { alert('è¯·å¡«å†™èº«ä»½è¯å·ï¼'); return; }
            // èº«ä»½è¯å·æ ¼å¼ç®€å•æ ¡éªŒ
            const idCardReg = /^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/;
            if (idCard.length !== 18 || !idCardReg.test(idCard)) {
                alert('è¯·å¡«å†™æœ‰æ•ˆçš„18ä½èº«ä»½è¯å·ï¼');
                return;
            }
            if (!date) { alert('è¯·é€‰æ‹©é¢„çº¦æ—¥æœŸï¼'); return; }
            if (!timeSlot) { alert('è¯·é€‰æ‹©é¢„çº¦æ—¶æ®µï¼'); return; }
            const partySize = parseInt(people);
            if (isNaN(partySize) || partySize < 1 || partySize > 20) {
                alert('è¯·å¡«å†™1-20ä¹‹é—´çš„æœ‰æ•ˆé¢„çº¦äººæ•°ï¼');
                return;
            }

            try {
                // ä¸¥æ ¼åŒ¹é…åç«¯Schemaçš„è¯·æ±‚ä½“ï¼ˆå…³é”®ä¿®æ­£ï¼‰
                const requestData = {
                    visitor_name: name,          // åç«¯è¦æ±‚çš„å­—æ®µå
                    id_card_no: idCard,          // åç«¯è¦æ±‚çš„å­—æ®µå
                    phone: phone || null,        // ç©ºå€¼ä¼ nullè€Œéç©ºå­—ç¬¦ä¸²
                    reserve_date: date,          // æ ¼å¼ï¼šYYYY-MM-DD åŒ¹é…åç«¯dateç±»å‹
                    time_slot: timeSlot,         // ä¸Šåˆ/ä¸‹åˆ/å…¨å¤©
                    party_size: partySize,       // ç¡®ä¿æ˜¯æ•´æ•°
                    area_id: areaId ? parseInt(areaId) : null, // åŒºåŸŸIDè½¬æ•´æ•°ï¼Œæ— åˆ™ä¼ null
                    ticket_amount: null          // åç«¯è‡ªåŠ¨è®¡ç®—ï¼Œä¼ null
                };

                // è°ƒç”¨åç«¯é¢„çº¦æ¥å£ï¼ˆä¿®å¤URLè·¯å¾„ï¼‰
                const res = await requestApi('/reservations', 'POST', requestData);

                // é¢„çº¦æˆåŠŸæç¤ºï¼ˆé€‚é…åç«¯è¿”å›æ ¼å¼ï¼‰
                alert(`é¢„çº¦æˆåŠŸï¼
é¢„çº¦ç¼–å·ï¼š${res.reservation_id || 'æœªçŸ¥'}
é¢„çº¦åŒºåŸŸIDï¼š${areaId}
åº”ä»˜é‡‘é¢ï¼š${res.ticket_amount || 0} å…ƒ
çŠ¶æ€ï¼š${res.status || 'å¾…å®¡æ ¸'}`);
                closeReservationModal();
            } catch (error) {
                // è¯¦ç»†çš„é”™è¯¯æç¤ºï¼ˆåŒºåˆ†401/500ç­‰ï¼‰
                let errorMsg = 'é¢„çº¦å¤±è´¥ï¼š';
                if (error.message.includes('401')) {
                    errorMsg += 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼';
                    // è§¦å‘é‡æ–°ç™»å½•ï¼ˆå¤ç”¨ç°æœ‰auth.jsé€»è¾‘ï¼‰
                    if (typeof Auth !== 'undefined') {
                        Auth.logout();
                        window.location.href = '/web/pages/login.html';
                    }
                } else if (error.message.includes('500')) {
                    errorMsg += 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ï¼';
                } else if (error.message.includes('403')) {
                    errorMsg += 'æ‚¨æ— é¢„çº¦æƒé™ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·è§’è‰²ï¼';
                } else {
                    errorMsg += error.message || 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•';
                }
                alert(errorMsg);
                console.error('é¢„çº¦æäº¤å¤±è´¥ï¼š', error);
            }
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const detailModal = document.getElementById('parkDetailModal');
            const resvModal = document.getElementById('reservationModal');
            if (event.target === detailModal) {
                closeParkDetail();
            } else if (event.target === resvModal) {
                closeReservationModal();
            }
        }

        // æ•°æ®é€‚é…å‡½æ•°
        function adaptParkData(rawData) {
            return rawData.map(item => ({
                area_id: item.area_id || item.id,
                area_name: item.area_name || item.name,
                area_type: item.area_type || item.type,
                area_size: item.area_size || item.area,
                longitude: item.longitude || item.lng,
                latitude: item.latitude || item.lat,
                protect_rules: item.protect_rules || item.main_protect,
                score: item.score || item.suitable_score,
                species_id: item.species_id || item.main_species_id
            }));
        }

        // åˆå§‹åŒ–å¸ƒå±€
        (function() {
            if (!Auth.requireLogin()) return;
            Common.initLayout({ active: "park-map" });
        })();
    </script>
</body>
</html>