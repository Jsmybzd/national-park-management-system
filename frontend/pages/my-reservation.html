<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é¢„çº¦å…¥å›­ - å›½å®¶å…¬å›­æ¸¸å®¢æœåŠ¡</title>
    <link rel="stylesheet" href="/web/assets/css/common.css" />
    <style>
      .page-header { margin-bottom: 24px; }
      .page-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
      .page-desc { color: var(--text-muted); font-size: 14px; }
      
      .reservation-form-card { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 32px; margin-bottom: 24px; }
      .form-title { font-size: 18px; font-weight: 600; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
      .form-title::before { content: 'ğŸ“'; }
      .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
      @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
      .form-group { display: flex; flex-direction: column; gap: 8px; }
      .form-group.full { grid-column: 1 / -1; }
      .form-label { font-size: 14px; font-weight: 500; color: var(--text-secondary); }
      .form-label .required { color: #ef4444; }
      .form-input, .form-select, .form-textarea { padding: 12px 14px; font-size: 14px; border: 1px solid #e5e7eb; border-radius: 10px; background: #f9fafb; outline: none; transition: all 0.2s; }
      .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(22,163,74,0.1); background: white; }
      .form-textarea { resize: vertical; min-height: 80px; }
      .form-actions { margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end; }
      
      .section-title { font-size: 18px; font-weight: 600; margin: 32px 0 16px; display: flex; align-items: center; gap: 10px; }
      .section-title::after { content: ''; flex: 1; height: 1px; background: var(--glass-border); }
      
      .reservation-list { display: flex; flex-direction: column; gap: 16px; }
      .reservation-card { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 24px; transition: all 0.2s; }
      .reservation-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
      .reservation-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
      .reservation-id { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
      .reservation-title { font-size: 18px; font-weight: 600; }
      .reservation-body { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
      @media (max-width: 768px) { .reservation-body { grid-template-columns: repeat(2, 1fr); } }
      .reservation-field { min-width: 0; }
      .reservation-field-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
      .reservation-field-value { font-size: 14px; font-weight: 500; }
      .reservation-footer { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
      .reservation-time { font-size: 12px; color: var(--text-muted); }
      
      .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; }
      .status-badge.pending { background: #fef3c7; color: #b45309; }
      .status-badge.approved { background: #d1fae5; color: #047857; }
      .status-badge.rejected { background: #fee2e2; color: #b91c1c; }
      .status-badge.completed { background: #e0e7ff; color: #4338ca; }
      .status-badge.cancelled { background: #f3f4f6; color: #6b7280; }
      
      .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
      .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
      .empty-state-text { font-size: 15px; margin-bottom: 20px; }
      
      .payment-status { display: inline-flex; align-items: center; gap: 4px; }
      .payment-status.paid { color: #047857; }
      .payment-status.unpaid { color: #b91c1c; }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside id="sidebar" class="sidebar"></aside>
      <div class="main">
        <header id="header" class="header"></header>
        <main class="content container">
          <div class="page-header">
            <h1 class="page-title">ğŸ« é¢„çº¦å…¥å›­</h1>
            <p class="page-desc">åœ¨çº¿é¢„çº¦å…¥å›­æ—¶é—´ï¼ŒæŸ¥çœ‹é¢„çº¦çŠ¶æ€å’Œå®¡æ ¸ç»“æœ</p>
          </div>
          
          <!-- é¢„çº¦è¡¨å• -->
          <div class="reservation-form-card">
            <div class="form-title">æ–°å»ºé¢„çº¦</div>
            <form id="reservationForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">é¢„çº¦äººå§“å <span class="required">*</span></label>
                  <input type="text" class="form-input" id="visitorName" required placeholder="è¯·è¾“å…¥å§“å" />
                </div>
                <div class="form-group">
                  <label class="form-label">èº«ä»½è¯å· <span class="required">*</span></label>
                  <input type="text" class="form-input" id="idCardNo" required placeholder="è¯·è¾“å…¥èº«ä»½è¯å·" maxlength="18" />
                </div>
                <!-- å…¬å›­é€‰æ‹© -->
                <div class="form-group">
                  <label class="form-label">é€‰æ‹©å…¬å›­ <span class="required">*</span></label>
                  <select class="form-select" id="areaId" required>
                    <option value="">è¯·é€‰æ‹©å…¬å›­</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">é¢„çº¦æ—¥æœŸ <span class="required">*</span></label>
                  <input type="date" class="form-input" id="reserveDate" required />
                </div>
                <div class="form-group">
                  <label class="form-label">é¢„çº¦æ—¶æ®µ <span class="required">*</span></label>
                  <select class="form-select" id="timeSlot" required>
                    <option value="">è¯·é€‰æ‹©æ—¶æ®µ</option>
                    <option value="ä¸Šåˆ">ä¸Šåˆ</option>
                    <option value="ä¸‹åˆ">ä¸‹åˆ</option>
                    <option value="å…¨å¤©">å…¨å¤©</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">é¢„çº¦äººæ•° <span class="required">*</span></label>
                  <input type="number" class="form-input" id="partySize" min="1" max="20" value="1" required />
                </div>
                <div class="form-group">
                  <label class="form-label">è”ç³»ç”µè¯</label>
                  <input type="tel" class="form-input" id="phone" placeholder="é€‰å¡«" />
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn" onclick="document.getElementById('reservationForm').reset(); initFormDefaults();">é‡ç½®</button>
                <button type="submit" class="btn btn-primary">æäº¤é¢„çº¦</button>
              </div>
            </form>
          </div>

          <!-- é¢„çº¦è®°å½•åˆ—è¡¨ -->
          <div class="section-title">ğŸ“‹ æˆ‘çš„é¢„çº¦è®°å½•</div>
          <div class="reservation-list" id="reservationList">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </main>
      </div>
    </div>

    <script src="/web/assets/js/api.js"></script>
    <script src="/web/assets/js/auth.js"></script>
    <script src="/web/assets/js/common.js"></script>
    <script>
      (function() {
        if (!Auth.requireLogin()) return;

        var profile = null;

        Common.initLayout({ active: "my-reservation" }).then(function(ctx) {
          profile = ctx.profile;
          initForm();
          loadReservations();
        });

        // åŠ è½½å…¬å›­åˆ—è¡¨
        async function loadParks() {
          try {
            const areas = await Api.requestJson("GET", "/api/visitor/areas");
            const select = document.getElementById("areaId");
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å…¬å›­</option>';
            areas.forEach(area => {
              const option = document.createElement("option");
              option.value = area.area_id;
              option.textContent = area.area_name;
              select.appendChild(option);
            });
          } catch (e) {
            Common.showToast("åŠ è½½å…¬å›­åˆ—è¡¨å¤±è´¥: " + Api.formatError(e), "error");
          }
        }

        function initForm() {
          initFormDefaults();
          loadParks();
          document.getElementById("reservationForm").addEventListener("submit", function(e) {
            e.preventDefault();
            submitReservation();
          });
        }

        function initFormDefaults() {
          var tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          document.getElementById("reserveDate").min = tomorrow.toISOString().split("T")[0];

          if (profile) {
            document.getElementById("visitorName").value = profile.name || "";
            document.getElementById("phone").value = profile.phone || "";
          }
        }

        // âœ… ä¿®æ­£åçš„ submitReservation â€”â€” å•ä¸€ã€æ— åµŒå¥—ã€è¯­æ³•æ­£ç¡®
        async function submitReservation() {
          const visitorName = document.getElementById("visitorName").value.trim();
          const idCardNo = document.getElementById("idCardNo").value.trim();
          const reserveDate = document.getElementById("reserveDate").value;
          const timeSlot = document.getElementById("timeSlot").value;
          const partySize = parseInt(document.getElementById("partySize").value) || 1;
          const phone = document.getElementById("phone").value.trim();
          const areaId = document.getElementById("areaId").value.trim();

          if (!visitorName || !idCardNo || !reserveDate || !timeSlot || !areaId) {
            Common.showToast("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹", "error");
            return;
          }

          if (idCardNo.length < 5) {
            Common.showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„èº«ä»½è¯å·", "error");
            return;
          }

          try {
            await Api.requestJson("POST", "/api/visitor/reservations", {
              visitor_name: visitorName,
              id_card_no: idCardNo,
              reserve_date: reserveDate,
              time_slot: timeSlot,
              party_size: partySize,
              phone: phone || null,
              area_id: parseInt(areaId)
            });

            Common.showToast("âœ… é¢„çº¦æäº¤æˆåŠŸï¼Œè¯·ç­‰å¾…å®¡æ ¸", "success");
            document.getElementById("reservationForm").reset();
            initFormDefaults();
            loadReservations();
          } catch (e) {
            Common.showToast("é¢„çº¦å¤±è´¥: " + Api.formatError(e), "error");
          }
        }

        async function loadReservations() {
          const container = document.getElementById("reservationList");
          try {
            const reservations = await Api.requestJson("GET", "/api/visitor/reservations/me") || [];

            if (reservations.length === 0) {
              container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">æš‚æ— é¢„çº¦è®°å½•</div></div>';
              return;
            }

            let html = '';
            reservations.forEach(r => {
              const status = r.reserve_status || "å¾…å®¡æ ¸";
              const statusClass = getStatusClass(status);
              const isPaid = r.pay_status === "å·²æ”¯ä»˜";
              const paymentHtml = `<span class="payment-status ${isPaid ? 'paid' : 'unpaid'}">${isPaid ? 'âœ“ å·²ä»˜æ¬¾' : 'âœ— æœªä»˜æ¬¾'}</span>`;

              html += `
                <div class="reservation-card">
                  <div class="reservation-header">
                    <div>
                      <div class="reservation-id">é¢„çº¦ç¼–å·: #${r.reservation_id}</div>
                      <div class="reservation-title">å…¥å›­é¢„çº¦ - ${r.visitor_name || ''}</div>
                    </div>
                    <span class="status-badge ${statusClass}">${status}</span>
                  </div>
                  <div class="reservation-body">
                    <div class="reservation-field">
                      <div class="reservation-field-label">é¢„çº¦æ—¥æœŸ</div>
                      <div class="reservation-field-value">${r.reserve_date || '-'}</div>
                    </div>
                    <div class="reservation-field">
                      <div class="reservation-field-label">é¢„çº¦æ—¶æ®µ</div>
                      <div class="reservation-field-value">${r.time_slot || 'å…¨å¤©'}</div>
                    </div>
                    <div class="reservation-field">
                      <div class="reservation-field-label">é¢„çº¦äººæ•°</div>
                      <div class="reservation-field-value">${r.party_size || 1} äºº</div>
                    </div>
                    <div class="reservation-field">
                      <div class="reservation-field-label">é¢„çº¦å…¬å›­</div>
                      <div class="reservation-field-value">${r.area_name || 'â€”'}</div>
                    </div>
                  </div>
                  <div class="reservation-footer">
                    <div class="reservation-time">ç¥¨ä»·: Â¥${r.ticket_amount || 0}</div>
                    <div>
                      ${status === "å¾…å®¡æ ¸" ? `<button class="btn btn-sm btn-danger" onclick="cancelReservation(${r.reservation_id}, '${r.id_card_no}')">å–æ¶ˆé¢„çº¦</button>` : ''}
                    </div>
                  </div>
                </div>
              `;
            });

            container.innerHTML = html;
          } catch (e) {
            container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-text">åŠ è½½å¤±è´¥: ${Api.formatError(e)}</div></div>`;
          }
        }

        function getStatusClass(status) {
          switch(status) {
            case "å¾…å®¡æ ¸": case "å¾…ç¡®è®¤": return "pending";
            case "å·²é€šè¿‡": case "å·²æ‰¹å‡†": case "å·²ç¡®è®¤": return "approved";
            case "å·²æ‹’ç»": case "æœªé€šè¿‡": case "å·²å–æ¶ˆ": return "rejected";
            case "å·²å®Œæˆ": return "completed";
            default: return "pending";
          }
        }

        window.cancelReservation = async function(reservationId, idCardNo) {
          Common.confirm("ç¡®å®šè¦å–æ¶ˆæ­¤é¢„çº¦å—ï¼Ÿ", async function() {
            try {
              await Api.requestJson("POST", `/api/visitor/reservations/${reservationId}/cancel?id_card_no=${encodeURIComponent(idCardNo)}`);
              Common.showToast("é¢„çº¦å·²å–æ¶ˆ", "success");
              loadReservations();
            } catch (e) {
              Common.showToast("å–æ¶ˆå¤±è´¥: " + Api.formatError(e), "error");
            }
          });
        };
      })();
    </script>
  </body>
</html>