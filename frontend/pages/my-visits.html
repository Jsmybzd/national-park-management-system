<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å…¥å›­è®°å½• - å›½å®¶å…¬å›­æ¸¸å®¢æœåŠ¡</title>
    <link rel="stylesheet" href="/web/assets/css/common.css" />
    <style>
      .page-header { margin-bottom: 24px; }
      .page-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
      .page-desc { color: var(--text-muted); font-size: 14px; }
      
      .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px; }
      @media (max-width: 768px) { .stats-row { grid-template-columns: 1fr; } }
      .stat-box { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 24px; text-align: center; }
      .stat-box-icon { font-size: 32px; margin-bottom: 12px; }
      .stat-box-value { font-size: 32px; font-weight: 700; color: var(--primary); }
      .stat-box-label { font-size: 14px; color: var(--text-muted); margin-top: 4px; }
      
      .visit-timeline { position: relative; padding-left: 32px; }
      .visit-timeline::before { content: ''; position: absolute; left: 11px; top: 0; bottom: 0; width: 2px; background: var(--border); }
      
      .visit-item { position: relative; margin-bottom: 24px; }
      .visit-item::before { content: ''; position: absolute; left: -21px; top: 8px; width: 12px; height: 12px; border-radius: 50%; background: var(--primary); border: 3px solid white; box-shadow: 0 0 0 2px var(--primary); }
      .visit-item.completed::before { background: #10b981; box-shadow: 0 0 0 2px #10b981; }
      .visit-item.in-progress::before { background: #f59e0b; box-shadow: 0 0 0 2px #f59e0b; animation: pulse 2s infinite; }
      
      @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
      
      .visit-card { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
      .visit-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
      .visit-date { font-size: 13px; color: var(--text-muted); }
      .visit-title { font-size: 18px; font-weight: 600; margin-top: 4px; }
      .visit-card-body { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
      @media (max-width: 768px) { .visit-card-body { grid-template-columns: 1fr; } }
      .visit-field-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
      .visit-field-value { font-size: 14px; font-weight: 500; }
      
      .duration-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 13px; background: #dbeafe; color: #1d4ed8; }
      
      .empty-state { text-align: center; padding: 80px 20px; color: var(--text-muted); }
      .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
      .empty-state-text { font-size: 16px; margin-bottom: 8px; }
      .empty-state-sub { font-size: 14px; }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside id="sidebar" class="sidebar"></aside>
      <div class="main">
        <header id="header" class="header"></header>
        <main class="content container">
          <div class="page-header">
            <h1 class="page-title">ğŸ“‹ å…¥å›­è®°å½•</h1>
            <p class="page-desc">æŸ¥çœ‹æ‚¨çš„å†å²å…¥å›­è®°å½•å’Œæ¸¸è§ˆæ—¶é•¿</p>
          </div>
          
          <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
          <div class="stats-row">
            <div class="stat-box">
              <div class="stat-box-icon">ğŸ«</div>
              <div class="stat-box-value" id="totalVisits">0</div>
              <div class="stat-box-label">æ€»å…¥å›­æ¬¡æ•°</div>
            </div>
            <div class="stat-box">
              <div class="stat-box-icon">â±ï¸</div>
              <div class="stat-box-value" id="totalHours">0</div>
              <div class="stat-box-label">æ€»æ¸¸è§ˆæ—¶é•¿(å°æ—¶)</div>
            </div>
            <div class="stat-box">
              <div class="stat-box-icon">ğŸ“…</div>
              <div class="stat-box-value" id="lastVisit">-</div>
              <div class="stat-box-label">ä¸Šæ¬¡å…¥å›­</div>
            </div>
          </div>
          
          <!-- å…¥å›­è®°å½•æ—¶é—´çº¿ -->
          <div class="section-title" style="font-size:18px;font-weight:600;margin-bottom:20px;">ğŸ• å…¥å›­å†å²</div>
          <div class="visit-timeline" id="visitTimeline">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </main>
      </div>
    </div>

    <script src="/web/assets/js/api.js"></script>
    <script src="/web/assets/js/auth.js"></script>
    <script src="/web/assets/js/common.js"></script>
    <script>
      (function() {
        if (!Auth.requireLogin()) return;
        
        Common.initLayout({ active: "my-visits" }).then(function(ctx) {
          loadVisits();
        });
        
        async function loadVisits() {
          var container = document.getElementById("visitTimeline");
          
          try {
            var resp = await Api.requestJson("GET", "/api/visitor/visits");
            var visits = resp.visits || resp || [];
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            var totalVisits = visits.length;
            var totalMinutes = 0;
            var lastVisitDate = null;
            
            visits.forEach(function(v) {
              if (v.entry_time && v.exit_time) {
                var entry = new Date(v.entry_time);
                var exit = new Date(v.exit_time);
                totalMinutes += (exit - entry) / 60000;
              }
              if (v.entry_time) {
                var d = new Date(v.entry_time);
                if (!lastVisitDate || d > lastVisitDate) lastVisitDate = d;
              }
            });
            
            document.getElementById("totalVisits").textContent = totalVisits;
            document.getElementById("totalHours").textContent = Math.round(totalMinutes / 60 * 10) / 10;
            document.getElementById("lastVisit").textContent = lastVisitDate ? 
              (lastVisitDate.getMonth() + 1) + "/" + lastVisitDate.getDate() : "-";
            
            if (visits.length === 0) {
              container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸï¸</div><div class="empty-state-text">æš‚æ— å…¥å›­è®°å½•</div><div class="empty-state-sub">é¢„çº¦æˆåŠŸåå…¥å›­å³å¯çœ‹åˆ°è®°å½•</div></div>';
              return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            visits.sort(function(a, b) {
              return new Date(b.entry_time || 0) - new Date(a.entry_time || 0);
            });
            
            var html = '';
            visits.forEach(function(v) {
              var entryTime = v.entry_time ? new Date(v.entry_time) : null;
              var exitTime = v.exit_time ? new Date(v.exit_time) : null;
              var isInProgress = entryTime && !exitTime;
              var duration = '-';
              
              if (entryTime && exitTime) {
                var mins = Math.round((exitTime - entryTime) / 60000);
                if (mins >= 60) {
                  duration = Math.floor(mins / 60) + 'å°æ—¶' + (mins % 60) + 'åˆ†é’Ÿ';
                } else {
                  duration = mins + 'åˆ†é’Ÿ';
                }
              } else if (isInProgress) {
                duration = 'æ¸¸è§ˆä¸­...';
              }
              
              var statusClass = isInProgress ? 'in-progress' : 'completed';
              var dateStr = entryTime ? (entryTime.getFullYear() + '-' + (entryTime.getMonth()+1) + '-' + entryTime.getDate()) : '-';
              
              html += '<div class="visit-item ' + statusClass + '">' +
                '<div class="visit-card">' +
                  '<div class="visit-card-header">' +
                    '<div><div class="visit-date">' + dateStr + '</div><div class="visit-title">å…¥å›­è®°å½• #' + v.id + '</div></div>' +
                    '<span class="duration-badge">â±ï¸ ' + duration + '</span>' +
                  '</div>' +
                  '<div class="visit-card-body">' +
                    '<div><div class="visit-field-label">å…¥å›­æ—¶é—´</div><div class="visit-field-value">' + Common.formatDate(v.entry_time) + '</div></div>' +
                    '<div><div class="visit-field-label">ç¦»å›­æ—¶é—´</div><div class="visit-field-value">' + (v.exit_time ? Common.formatDate(v.exit_time) : '<span style="color:#f59e0b;">æ¸¸è§ˆä¸­</span>') + '</div></div>' +
                    '<div><div class="visit-field-label">å…¥å›­æ–¹å¼</div><div class="visit-field-value">' + (v.entry_method || 'æ­£å¸¸å…¥å›­') + '</div></div>' +
                  '</div>' +
                '</div>' +
              '</div>';
            });
            
            container.innerHTML = html;
          } catch (e) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-text">åŠ è½½å¤±è´¥</div><div class="empty-state-sub">' + Api.formatError(e) + '</div></div>';
          }
        }
      })();
    </script>
  </body>
</html>
