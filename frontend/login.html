<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç™»å½• - å›½å®¶å…¬å›­æ™ºæ…§ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/web/assets/css/common.css" />
    <link rel="stylesheet" href="/web/assets/css/login.css" />
  </head>
  <body>
    <div class="login-page">
      <div class="login-bg"></div>
      
      <!-- å·¦ä¾§å“ç‰ŒåŒº -->
      <div class="login-brand">
        <div class="login-brand-content">
          <div class="login-logo">
            <div class="login-logo-icon">ğŸŒ²</div>
            <div class="login-logo-text">å›½å®¶å…¬å›­ç®¡ç†ç³»ç»Ÿ</div>
          </div>
          
          <h1 class="login-headline">æ™ºæ…§ç®¡ç†<br/>ç”Ÿæ€ä¿æŠ¤</h1>
          <p class="login-tagline">
            æ•´åˆç¯å¢ƒç›‘æµ‹ã€ç§‘ç ”æ•°æ®ã€æ‰§æ³•ç›‘ç®¡ã€æ¸¸å®¢æœåŠ¡ä¸ç”Ÿç‰©å¤šæ ·æ€§ä¿æŠ¤ï¼Œ
            ä¸ºå›½å®¶å…¬å›­æä¾›å…¨æ–¹ä½çš„æ•°å­—åŒ–ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚
          </p>
          
          <div class="login-features">
            <div class="login-feature">
              <div class="login-feature-icon">ğŸ“Š</div>
              <div class="login-feature-text">å®æ—¶ç¯å¢ƒç›‘æµ‹ä¸æ•°æ®åˆ†æ</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">ğŸ”¬</div>
              <div class="login-feature-text">ç§‘ç ”é¡¹ç›®ä¸æˆæœç®¡ç†</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">ğŸ›¡ï¸</div>
              <div class="login-feature-text">æ™ºèƒ½æ‰§æ³•è°ƒåº¦ä¸ç›‘ç®¡</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">ğŸ¦</div>
              <div class="login-feature-text">ç”Ÿç‰©å¤šæ ·æ€§ä¿æŠ¤è¿½è¸ª</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å³ä¾§ç™»å½•è¡¨å• -->
      <div class="login-form-section">
        <div class="login-card">
          <div class="login-card-header">
            <h2 class="login-card-title">æ¬¢è¿ç™»å½•</h2>
            <p class="login-card-subtitle">ä½¿ç”¨æ‰‹æœºå·å’Œå¯†ç è¿›è¡Œèº«ä»½éªŒè¯</p>
          </div>
          
          <form id="loginForm" class="login-form">
            <div class="login-field">
              <label class="login-field-label" for="phone">æ‰‹æœºå·</label>
              <input 
                id="phone" 
                class="login-field-input" 
                type="tel" 
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                autocomplete="tel"
                required 
              />
            </div>
            
            <div class="login-field">
              <label class="login-field-label" for="password">å¯†ç </label>
              <input 
                id="password" 
                class="login-field-input" 
                type="password" 
                placeholder="è¯·è¾“å…¥å¯†ç "
                autocomplete="current-password"
                required 
              />
            </div>
            
            <button class="login-submit" type="submit" id="submitBtn">
              ç™»å½•ç³»ç»Ÿ
            </button>
            
            <div id="error" class="login-error" style="display: none">
              <span>âš ï¸</span>
              <span id="errorText"></span>
            </div>
            
            <!-- æ–°å¢æ³¨å†Œå…¥å£ -->
            <div class="login-register-link" style="margin-top: 15px; text-align: right;">
              <a href="/web/register.html" style="color: #1890ff; font-size: 14px; text-decoration: none;">
                è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ
              </a>
            </div>
          </form>
          
          <div class="login-footer">
            å›½å®¶å…¬å›­æ™ºæ…§ç®¡ç†ä¸ç”Ÿæ€ä¿æŠ¤ç³»ç»Ÿ v1.0
          </div>
        </div>
      </div>
    </div>

    <script src="/web/assets/js/api.js"></script>
    <script src="/web/assets/js/auth.js"></script>
    <script>
      (function () {
        // å¦‚æœå·²ç™»å½•ï¼Œç›´æ¥è·³è½¬åˆ°é¦–é¡µ
        if (window.Auth && Auth.getToken()) {
          window.location.href = "/web/index.html";
          return;
        }

        // è·å–DOMå…ƒç´ 
        var form = document.getElementById("loginForm");
        var phoneEl = document.getElementById("phone");
        var passwordEl = document.getElementById("password");
        var errorEl = document.getElementById("error");
        var errorText = document.getElementById("errorText");
        var submitBtn = document.getElementById("submitBtn");

        // æ˜¾ç¤ºé”™è¯¯æç¤º
        function showError(msg) {
          errorText.textContent = msg || "ç™»å½•å¤±è´¥";
          errorEl.style.display = "flex";
        }

        // éšè—é”™è¯¯æç¤º
        function hideError() {
          errorEl.style.display = "none";
        }

        // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
        function setLoading(loading) {
          submitBtn.disabled = loading;
          submitBtn.textContent = loading ? "ç™»å½•ä¸­..." : "ç™»å½•ç³»ç»Ÿ";
        }

        // è¡¨å•æäº¤äº‹ä»¶
        form.addEventListener("submit", async function (e) {
          e.preventDefault();
          hideError();
          setLoading(true);

          try {
            // æ„å»ºè¯·æ±‚å‚æ•°
            var payload = {
              phone: (phoneEl.value || "").trim(),
              password: (passwordEl.value || "").trim(),
            };

            // åŸºç¡€æ ¡éªŒ
            if (!payload.phone) {
              showError("è¯·è¾“å…¥æ‰‹æœºå·");
              setLoading(false);
              return;
            }
            if (!/^1[3-9]\d{9}$/.test(payload.phone)) {
              showError("è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼");
              setLoading(false);
              return;
            }
            if (!payload.password) {
              showError("è¯·è¾“å…¥å¯†ç ");
              setLoading(false);
              return;
            }

            // è°ƒç”¨ç™»å½•æ¥å£
            var res = await Api.requestJson("POST", "/api/core/login", payload);
            
            // æ¥å£å“åº”æ ¡éªŒ
            if (!res || !res.token) {
              showError("ç™»å½•å“åº”å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
              setLoading(false);
              return;
            }
            
            // ç™»å½•æˆåŠŸï¼Œä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯
            Auth.setToken(res.token);
            Auth.setProfile({
              user_id: res.user_id,
              name: res.name,
              role_type: res.role_type,
              permissions: res.permissions || [],
            });
            
            // è·³è½¬åˆ°é¦–é¡µ
            window.location.href = "/web/index.html";
          } catch (err) {
            // æ•è·é”™è¯¯å¹¶æ˜¾ç¤º
            showError(Api.formatError(err) || "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            setLoading(false);
          }
        });

        // è¾“å…¥æ¡†èšç„¦æ—¶éšè—é”™è¯¯æç¤º
        phoneEl.addEventListener("focus", hideError);
        passwordEl.addEventListener("focus", hideError);
      })();
    </script>
  </body>
</html>