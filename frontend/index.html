<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ§åˆ¶å° - å›½å®¶å…¬å›­æ™ºæ…§ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/web/assets/css/common.css" />
    <style>
      .dashboard-welcome { margin-bottom: 32px; }
      .welcome-text { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
      .welcome-sub { color: var(--text-muted); font-size: 15px; }
      .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
      @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } }
      .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
      .section-title::after { content: ''; flex: 1; height: 1px; background: var(--glass-border); }
      .modules-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px; }
      @media (max-width: 1024px) { .modules-grid { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 600px) { .modules-grid { grid-template-columns: 1fr; } }
      .quick-actions { display: flex; gap: 12px; flex-wrap: wrap; }
      .activity-list { display: flex; flex-direction: column; gap: 12px; }
      .activity-item { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius-md); }
      .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; background: var(--glass-hover); }
      .activity-content { flex: 1; }
      .activity-title { font-weight: 500; margin-bottom: 2px; }
      .activity-time { font-size: 12px; color: var(--text-muted); }
      .two-col { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
      @media (max-width: 1024px) { .two-col { grid-template-columns: 1fr; } }
      
      /* ç”¨æˆ·ç«¯æ ·å¼ */
      .user-profile-card { background: linear-gradient(135deg, #16a34a, #15803d); color: white; border-radius: 16px; padding: 32px; margin-bottom: 24px; }
      .user-profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
      .user-avatar-large { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: 700; }
      .user-info h2 { font-size: 24px; margin-bottom: 4px; }
      .user-info p { opacity: 0.9; font-size: 14px; }
      .user-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
      .user-stat { text-align: center; padding: 16px; background: rgba(255,255,255,0.15); border-radius: 12px; }
      .user-stat-value { font-size: 28px; font-weight: 700; }
      .user-stat-label { font-size: 13px; opacity: 0.9; margin-top: 4px; }
      .service-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px; }
      @media (max-width: 768px) { .service-cards { grid-template-columns: 1fr; } }
      .service-card { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 24px; display: flex; flex-direction: column; transition: all 0.2s; }
      .service-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
      .service-card-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 16px; }
      .service-card-icon.green { background: linear-gradient(135deg, rgba(22,163,74,0.15), rgba(22,163,74,0.05)); }
      .service-card-icon.blue { background: linear-gradient(135deg, rgba(14,165,233,0.15), rgba(14,165,233,0.05)); }
      .service-card-icon.purple { background: linear-gradient(135deg, rgba(168,85,247,0.15), rgba(168,85,247,0.05)); }
      .service-card-icon.orange { background: linear-gradient(135deg, rgba(249,115,22,0.15), rgba(249,115,22,0.05)); }
      .service-card h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
      .service-card p { color: var(--text-muted); font-size: 14px; line-height: 1.5; flex: 1; }
      .service-card .btn { margin-top: 16px; }
      .reservation-list { margin-top: 8px; }
      .reservation-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 12px; }
      .reservation-info { display: flex; align-items: center; gap: 16px; }
      .reservation-date { width: 60px; text-align: center; }
      .reservation-date .day { font-size: 24px; font-weight: 700; color: var(--primary); }
      .reservation-date .month { font-size: 12px; color: var(--text-muted); }
      .reservation-detail h4 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
      .reservation-detail p { font-size: 13px; color: var(--text-muted); }

      /* è¡¨å•è¾“å…¥ç»Ÿä¸€é£æ ¼ */
      .form-input, .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
      }
      .form-group label {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 6px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside id="sidebar" class="sidebar"></aside>
      <div class="main">
        <header id="header" class="header"></header>
        <main class="content container">
          <!-- ç®¡ç†ç«¯å†…å®¹ -->
          <div id="adminDashboard" style="display:none;">
            <div class="dashboard-welcome">
              <h1 class="welcome-text">æ¬¢è¿å›æ¥ï¼Œ<span id="adminUserName">ç®¡ç†å‘˜</span> ğŸ‘‹</h1>
              <p class="welcome-sub">è¿™æ˜¯æ‚¨çš„å›½å®¶å…¬å›­ç®¡ç†æ§åˆ¶å°ï¼Œå¯ä»¥å¿«é€Ÿè®¿é—®å„é¡¹åŠŸèƒ½æ¨¡å—ã€‚</p>
            </div>
            <div class="stats-grid">
              <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value" id="statVisitors">--</div><div class="stat-label">ä»Šæ—¥æ¸¸å®¢</div></div>
              <div class="stat-card"><div class="stat-icon accent">ğŸ”¬</div><div class="stat-value" id="statProjects">--</div><div class="stat-label">è¿›è¡Œä¸­é¡¹ç›®</div></div>
              <div class="stat-card"><div class="stat-icon warning">âš ï¸</div><div class="stat-value" id="statAlerts">--</div><div class="stat-label">å¾…å¤„ç†å‘Šè­¦</div></div>
              <div class="stat-card"><div class="stat-icon info">ğŸ¦</div><div class="stat-value" id="statSpecies">--</div><div class="stat-label">ç‰©ç§è®°å½•</div></div>
            </div>
            <div class="section-title">åŠŸèƒ½æ¨¡å—</div>
            <div class="modules-grid">
              <a class="nav-card" href="/web/pages/visitor.html"><div class="nav-card-icon">ğŸ«</div><div class="nav-card-title">æ¸¸å®¢æœåŠ¡</div><div class="nav-card-desc">é¢„çº¦ç®¡ç†ã€å…¥å›­è®°å½•ã€æµé‡ç›‘æ§</div></a>
              <a class="nav-card" href="/web/pages/environment.html"><div class="nav-card-icon">ğŸŒ¡ï¸</div><div class="nav-card-title">ç”Ÿæ€ç¯å¢ƒç›‘æµ‹</div><div class="nav-card-desc">ç›‘æµ‹æŒ‡æ ‡ã€è®¾å¤‡ç®¡ç†ã€ç¯å¢ƒæ•°æ®</div></a>
              <a class="nav-card" href="/web/pages/enforcement.html"><div class="nav-card-icon">ğŸ›¡ï¸</div><div class="nav-card-title">æ‰§æ³•ç›‘ç®¡</div><div class="nav-card-desc">æ‰§æ³•äººå‘˜ã€å·¡æŸ¥è®°å½•ã€è¿è§„å¤„ç†</div></a>
              <a class="nav-card" href="/web/pages/research.html"><div class="nav-card-icon">ğŸ”¬</div><div class="nav-card-title">ç§‘ç ”æ•°æ®</div><div class="nav-card-desc">ç§‘ç ”é¡¹ç›®ã€æ ·æœ¬é‡‡é›†ã€ç ”ç©¶æˆæœ</div></a>
              <a class="nav-card" href="/web/pages/biodiversity.html"><div class="nav-card-icon">ğŸ¦‹</div><div class="nav-card-title">ç”Ÿç‰©å¤šæ ·æ€§</div><div class="nav-card-desc">ç‰©ç§æ¡£æ¡ˆã€æ –æ¯åœ°ç®¡ç†</div></a>
              <a class="nav-card" href="#" style="opacity:0.5;pointer-events:none;"><div class="nav-card-icon">âš™ï¸</div><div class="nav-card-title">ç³»ç»Ÿè®¾ç½®</div><div class="nav-card-desc">å¼€å‘ä¸­...</div></a>
            </div>
            <div class="notice notice-info"><strong>ç³»ç»Ÿä¿¡æ¯ï¼š</strong>å½“å‰è§’è‰² <span id="roleTag" class="tag tag-primary">åŠ è½½ä¸­</span></div>
          </div>

          <!-- ç”¨æˆ·ç«¯å†…å®¹ - æ¸¸å®¢æœåŠ¡ä¸­å¿ƒ -->
          <div id="userDashboard" style="display:none;">
            <div class="user-profile-card">
              <div class="user-profile-header">
                <div class="user-avatar-large" id="userAvatarLarge">å¼ </div>
                <div class="user-info">
                  <h2 id="userDisplayName">æ¸¸å®¢</h2>
                  <p>ğŸ« æ¬¢è¿æ¥åˆ°å›½å®¶å…¬å›­æ¸¸å®¢æœåŠ¡ä¸­å¿ƒ</p>
                </div>
              </div>
              <div class="user-stats">
                <div class="user-stat"><div class="user-stat-value" id="userReservationCount">0</div><div class="user-stat-label">é¢„çº¦æ¬¡æ•°</div></div>
                <div class="user-stat"><div class="user-stat-value" id="userVisitCount">0</div><div class="user-stat-label">å…¥å›­æ¬¡æ•°</div></div>
                <div class="user-stat"><div class="user-stat-value" id="userPendingCount">0</div><div class="user-stat-label">å¾…å®¡æ ¸</div></div>
              </div>
            </div>

            <!-- é¢„çº¦å…¥å›­è¡¨å• -->
            <div class="section-title">ğŸ“ é¢„çº¦å…¥å›­</div>
            <div class="card" style="margin-bottom:24px;">
              <div class="card-body">
                <form id="reservationForm" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
                  <div class="form-group">
                    <label>é¢„çº¦äººå§“å <span style="color:red">*</span></label>
                    <input type="text" class="form-input" id="visitorName" required placeholder="è¯·è¾“å…¥å§“å" />
                  </div>
                  <div class="form-group">
                    <label>èº«ä»½è¯å· <span style="color:red">*</span></label>
                    <input type="text" class="form-input" id="idCardNo" required placeholder="è¯·è¾“å…¥èº«ä»½è¯å·" maxlength="18" />
                  </div>
                  <div class="form-group">
                    <label>é€‰æ‹©å…¬å›­ <span style="color:red">*</span></label>
                    <select class="form-select" id="areaId" required>
                      <option value="">è¯·é€‰æ‹©å…¬å›­</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>è”ç³»ç”µè¯</label>
                    <input type="tel" class="form-input" id="phone" placeholder="é€‰å¡«" />
                  </div>
                  <div class="form-group">
                    <label>é¢„çº¦æ—¥æœŸ <span style="color:red">*</span></label>
                    <input type="date" class="form-input" id="reserveDate" required />
                  </div>
                  <div class="form-group">
                    <label>é¢„çº¦æ—¶æ®µ <span style="color:red">*</span></label>
                    <select class="form-select" id="timeSlot" required>
                      <option value="">è¯·é€‰æ‹©</option>
                      <option value="ä¸Šåˆ">ä¸Šåˆ</option>
                      <option value="ä¸‹åˆ">ä¸‹åˆ</option>
                      <option value="å…¨å¤©">å…¨å¤©</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>é¢„çº¦äººæ•° <span style="color:red">*</span></label>
                    <input type="number" class="form-input" id="partySize" min="1" max="20" value="1" required />
                  </div>
                  <div style="grid-column:1/-1;text-align:right;margin-top:8px;">
                    <button type="submit" class="btn btn-primary">æäº¤é¢„çº¦</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- æˆ‘çš„é¢„çº¦è®°å½• -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
              <div class="section-title" style="margin:0;">ğŸ« æˆ‘çš„é¢„çº¦</div>
              <button class="btn btn-secondary" onclick="toggleMyReservations()" id="toggleReservationsBtn">ğŸ“‹ æŸ¥çœ‹æˆ‘çš„é¢„çº¦</button>
            </div>
            <div class="card" id="myReservationsCard" style="display:none;">
              <div class="card-body">
                <div class="reservation-list" id="recentReservations">
                  <div class="loading">åŠ è½½ä¸­...</div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="/web/assets/js/api.js"></script>
    <script src="/web/assets/js/auth.js"></script>
    <script src="/web/assets/js/common.js"></script>
    <script>
      (function () {
        if (!Auth.requireLogin()) return;

        var userProfile = null;
        var parkList = []; // å­˜å‚¨å…¬å›­åˆ—è¡¨

        Common.initLayout({ active: "home" }).then(function (ctx) {
          var profile = ctx.profile;
          userProfile = profile;
          var isAdmin = ctx.isAdmin;

          if (isAdmin) {
            document.getElementById("adminDashboard").style.display = "block";
            document.getElementById("adminUserName").textContent = profile.name || "ç®¡ç†å‘˜";
            document.getElementById("roleTag").textContent = profile.role_type || "ç®¡ç†å‘˜";
            loadAdminStats();
          } else {
            document.getElementById("userDashboard").style.display = "block";
            document.getElementById("userDisplayName").textContent = profile.name || "æ¸¸å®¢";
            document.getElementById("userAvatarLarge").textContent = (profile.name || "æ¸¸").charAt(0);
            initUserForm(profile);
            loadUserStats(profile);
          }
        });

        // âœ… åŠ è½½å…¬å›­åˆ—è¡¨ï¼ˆå®Œæ•´å®ç°ï¼‰
        async function loadParks() {
          try {
            const areas = await Api.requestJson("GET", "/api/visitor/areas");
            parkList = Array.isArray(areas) ? areas : [];
            const select = document.getElementById("areaId");
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å…¬å›­</option>';
            parkList.forEach(area => {
              const option = document.createElement("option");
              option.value = area.area_id;
              option.textContent = area.area_name;
              select.appendChild(option);
            });
          } catch (e) {
            console.error("åŠ è½½å…¬å›­åˆ—è¡¨å¤±è´¥:", e);
            Common.showToast("åŠ è½½å…¬å›­åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", "error");
          }
        }

        function initUserForm(profile) {
          // è®¾ç½®æœ€å°æ—¥æœŸä¸ºæ˜å¤©
          var tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          document.getElementById("reserveDate").min = tomorrow.toISOString().split("T")[0];

          // è‡ªåŠ¨å¡«å……ç”¨æˆ·ä¿¡æ¯
          if (profile) {
            document.getElementById("visitorName").value = profile.name || "";
            document.getElementById("phone").value = profile.phone || "";
          }

          // åŠ è½½å…¬å›­åˆ—è¡¨
          loadParks();

          // è¡¨å•æäº¤
          document.getElementById("reservationForm").addEventListener("submit", function(e) {
            e.preventDefault();
            submitReservation();
          });
        }

        async function submitReservation() {
          var visitorName = document.getElementById("visitorName").value.trim();
          var idCardNo = document.getElementById("idCardNo").value.trim();
          var reserveDate = document.getElementById("reserveDate").value;
          var timeSlot = document.getElementById("timeSlot").value;
          var partySize = parseInt(document.getElementById("partySize").value) || 1;
          var phone = document.getElementById("phone").value.trim();
          var areaId = document.getElementById("areaId").value;

          if (!visitorName || !idCardNo || !reserveDate || !timeSlot || !areaId) {
            Common.showToast("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹", "error");
            return;
          }

          if (idCardNo.length < 5) {
            Common.showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„èº«ä»½è¯å·", "error");
            return;
          }

          try {
            var ticketAmount = partySize * 120;  // æ¯äºº120å…ƒ
            var result = await Api.requestJson("POST", "/api/visitor/reservations", {
              visitor_name: visitorName,
              id_card_no: idCardNo,
              reserve_date: reserveDate,
              time_slot: timeSlot,
              party_size: partySize,
              phone: phone || null,
              area_id: parseInt(areaId),
              ticket_amount: ticketAmount
            });
            Common.showToast("âœ… é¢„çº¦æˆåŠŸï¼éœ€ä»˜æ¬¾: Â¥" + ticketAmount + "ï¼Œè¯·ç­‰å¾…å®¡æ ¸", "success");
            // é‡ç½®è¡¨å•ä½†ä¿ç•™ç”¨æˆ·åå’Œç”µè¯
            document.getElementById("idCardNo").value = "";
            document.getElementById("areaId").value = "";
            document.getElementById("reserveDate").value = "";
            document.getElementById("timeSlot").value = "";
            document.getElementById("partySize").value = "1";
            // åˆ·æ–°ç»Ÿè®¡å’Œåˆ—è¡¨
            loadUserStats(userProfile);
          } catch (e) {
            Common.showToast("é¢„çº¦å¤±è´¥: " + Api.formatError(e), "error");
          }
        }

        async function loadAdminStats() {
          // ç»Ÿè®¡ï¼šä»Šæ—¥æ¸¸å®¢
          try {
            var reservationsResp = await Api.requestJson("GET", "/api/visitor/reservations");
            var reservations = Array.isArray(reservationsResp) ? reservationsResp : [];
            var totalVisitors = reservations.reduce(function(sum, r) {
              var size = r.party_size || r.PartySize || r.partySize || 1;
              return sum + parseInt(size);
            }, 0);
            document.getElementById("statVisitors").textContent = totalVisitors > 0 ? totalVisitors : reservations.length;
          } catch (e) {
            document.getElementById("statVisitors").textContent = "0";
          }

          // ç»Ÿè®¡ï¼šè¿›è¡Œä¸­é¡¹ç›®
          try {
            var projectsResp = await Api.requestJson("GET", "/api/research/projects");
            var projects = Array.isArray(projectsResp) ? projectsResp : (projectsResp.projects || []);
            var activeCount = projects.filter(function(p) {
              var st = p.status || p.Status || "";
              return st === "åœ¨ç ”";
            }).length;
            document.getElementById("statProjects").textContent = activeCount;
          } catch (e) {
            document.getElementById("statProjects").textContent = "0";
          }

          // ç»Ÿè®¡ï¼šå¾…å¤„ç†å‘Šè­¦
          try {
            var alertsResp = await Api.requestJson("GET", "/api/visitor/alerts");
            var alerts = Array.isArray(alertsResp) ? alertsResp : (alertsResp.alerts || []);
            var pendingCount = alerts.filter(function(a) {
              var st = a.Status || a.status || "";
              return st === "æœªå¤„ç†";
            }).length;
            document.getElementById("statAlerts").textContent = pendingCount;
          } catch (e) {
            document.getElementById("statAlerts").textContent = "0";
          }

          // ç»Ÿè®¡ï¼šç‰©ç§è®°å½•
          try {
            var speciesResp = await Api.requestJson("GET", "/api/biodiversity/species?page=1&page_size=1");
            document.getElementById("statSpecies").textContent = speciesResp.total || 0;
          } catch (e) {
            document.getElementById("statSpecies").textContent = "0";
          }
        }

        var reservationsVisible = false;
        window.toggleMyReservations = function() {
          reservationsVisible = !reservationsVisible;
          var card = document.getElementById('myReservationsCard');
          var btn = document.getElementById('toggleReservationsBtn');
          if (reservationsVisible) {
            card.style.display = 'block';
            btn.textContent = 'ğŸ”¼ æ”¶èµ·é¢„çº¦åˆ—è¡¨';
            loadUserStats(userProfile);
          } else {
            card.style.display = 'none';
            btn.textContent = 'ğŸ“‹ æŸ¥çœ‹æˆ‘çš„é¢„çº¦';
          }
        }

        async function loadUserStats(profile) {
          var reservationCount = 0, visitCount = 0, pendingCount = 0;
          var recentHtml = '';

          try {
            var reservations = await Api.requestJson("GET", "/api/visitor/reservations/me");
            reservations = reservations || [];

            var seen = {};
            reservations = reservations.filter(function(r) {
              var id = r.reservation_id || r.ReservationId;
              if (seen[id]) return false;
              seen[id] = true;
              return true;
            });

            reservationCount = reservations.length;
            pendingCount = reservations.filter(function(r) {
              var st = r.reserve_status || r.ReserveStatus || "";
              return st === "å¾…å®¡æ ¸" || st === "å¾…ç¡®è®¤";
            }).length;

            if (reservations.length > 0) {
              reservations.forEach(function(r) {
                var date = new Date(r.reserve_date || r.ReserveDate);
                var status = r.reserve_status || r.ReserveStatus || "å¾…å®¡æ ¸";
                var payStatus = r.pay_status || r.PayStatus || "æœªæ”¯ä»˜";
                var visitorName = r.visitor_name || r.VisitorName || "";
                var idCard = r.id_card_no || r.IdCardNo || "";
                var partySize = r.party_size || r.PartySize || 1;
                var timeSlot = r.time_slot || r.TimeSlot || "å…¨å¤©";
                var ticketAmount = r.ticket_amount || r.TicketAmount || 0;
                var resId = r.reservation_id || r.ReservationId;
                var areaName = r.area_name || "æœªçŸ¥å…¬å›­";

                var statusBg = (status === "å·²ç¡®è®¤" || status === "å·²é€šè¿‡") ? "#d1fae5" :
                               (status === "å¾…å®¡æ ¸" || status === "å¾…ç¡®è®¤") ? "#fef3c7" :
                               (status === "å·²å–æ¶ˆ" || status === "å·²æ‹’ç»") ? "#fee2e2" : "#f3f4f6";
                var statusColor = (status === "å·²ç¡®è®¤" || status === "å·²é€šè¿‡") ? "#047857" :
                                  (status === "å¾…å®¡æ ¸" || status === "å¾…ç¡®è®¤") ? "#b45309" :
                                  (status === "å·²å–æ¶ˆ" || status === "å·²æ‹’ç»") ? "#b91c1c" : "#6b7280";

                var maskedId = idCard.length > 6 ? idCard.substring(0, 3) + "****" + idCard.substring(idCard.length - 4) : idCard;

                recentHtml += '<div class="reservation-item" style="flex-direction:column;align-items:stretch;gap:12px;">' +
                  '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                    '<div class="reservation-info">' +
                      '<div class="reservation-date"><div class="day">' + date.getDate() + '</div><div class="month">' + (date.getMonth()+1) + 'æœˆ</div></div>' +
                      '<div class="reservation-detail">' +
                        '<h4>é¢„çº¦ #' + resId + '</h4>' +
                        '<p>ğŸ‘¤ ' + visitorName + ' Â· ğŸªª ' + maskedId + '</p>' +
                        '<p>ğŸ“ ' + areaName + '</p>' +
                      '</div>' +
                    '</div>' +
                    '<span style="padding:6px 12px;border-radius:20px;font-size:13px;font-weight:500;background:' + statusBg + ';color:' + statusColor + ';">' + status + '</span>' +
                  '</div>' +
                  '<div style="display:flex;gap:16px;padding-left:76px;font-size:13px;color:var(--text-muted);">' +
                    '<span>ğŸ‘¥ ' + partySize + 'äºº</span>' +
                    '<span>ğŸ• ' + timeSlot + '</span>' +
                    '<span>ğŸ’° Â¥' + ticketAmount + '</span>' +
                    '<span>ğŸ“‹ ' + payStatus + '</span>' +
                  '</div>' +
                '</div>';
              });
            } else {
              recentHtml = '<div style="text-align:center;padding:40px;color:var(--text-muted);">æš‚æ— é¢„çº¦è®°å½•ï¼Œè¯·åœ¨ä¸Šæ–¹è¡¨å•ä¸­æäº¤é¢„çº¦</div>';
            }
          } catch (e) {
            console.error("åŠ è½½é¢„çº¦å¤±è´¥:", e);
            recentHtml = '<div style="text-align:center;padding:40px;color:var(--text-muted);">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
          }

          visitCount = 0;

          document.getElementById("userReservationCount").textContent = reservationCount;
          document.getElementById("userVisitCount").textContent = visitCount;
          document.getElementById("userPendingCount").textContent = pendingCount;
          document.getElementById("recentReservations").innerHTML = recentHtml;
        }
      })();
    </script>
  </body>
</html>
