<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>注册 - 国家公园智慧管理系统</title>
    <link rel="stylesheet" href="/web/assets/css/common.css" />
    <link rel="stylesheet" href="/web/assets/css/login.css" />
  </head>
  <body>
    <div class="login-page">
      <div class="login-bg"></div>
      
      <!-- 左侧品牌区 -->
      <div class="login-brand">
        <div class="login-brand-content">
          <div class="login-logo">
            <div class="login-logo-icon">🌲</div>
            <div class="login-logo-text">国家公园管理系统</div>
          </div>
          
          <h1 class="login-headline">智慧管理<br/>生态保护</h1>
          <p class="login-tagline">
            整合环境监测、科研数据、执法监管、游客服务与生物多样性保护，
            为国家公园提供全方位的数字化管理解决方案。
          </p>
          
          <div class="login-features">
            <div class="login-feature">
              <div class="login-feature-icon">📊</div>
              <div class="login-feature-text">实时环境监测与数据分析</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">🔬</div>
              <div class="login-feature-text">科研项目与成果管理</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">🛡️</div>
              <div class="login-feature-text">智能执法调度与监管</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">🦁</div>
              <div class="login-feature-text">生物多样性保护追踪</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 右侧注册表单 -->
      <div class="login-form-section">
        <div class="login-card">
          <div class="login-card-header">
            <h2 class="login-card-title">用户注册</h2>
            <p class="login-card-subtitle">填写信息完成账号注册</p>
          </div>
          
          <form id="registerForm" class="login-form">
            <div class="login-field">
              <label class="login-field-label" for="phone">手机号</label>
              <input 
                id="phone" 
                class="login-field-input" 
                type="tel" 
                placeholder="请输入手机号"
                autocomplete="tel"
                required 
              />
            </div>
            
            <div class="login-field">
              <label class="login-field-label" for="name">姓名</label>
              <input 
                id="name" 
                class="login-field-input" 
                type="text" 
                placeholder="请输入真实姓名"
                autocomplete="name"
                required 
              />
            </div>
            
            <div class="login-field">
              <label class="login-field-label" for="password">密码</label>
              <input 
                id="password" 
                class="login-field-input" 
                type="password" 
                placeholder="请设置登录密码"
                autocomplete="new-password"
                required 
              />
            </div>
            
            <div class="login-field">
              <label class="login-field-label" for="roleType">角色类型</label>
              <select id="roleType" class="login-field-input" required>
                <option value="" disabled selected>请选择角色</option>
                <option value="游客">游客</option>
                <option value="公园管理人员">公园管理人员</option>
                <option value="数据分析员">数据分析员</option>
                <option value="执法人员">执法人员</option>
              </select>
            </div>
            
            <button class="login-submit" type="submit" id="submitBtn">
              完成注册
            </button>
            
            <div id="error" class="login-error" style="display: none">
              <span>⚠️</span>
              <span id="errorText"></span>
            </div>
            
            <!-- 登录入口 -->
            <div class="login-login-link" style="margin-top: 15px; text-align: right;">
              <a href="/web/login.html" style="color: #1890ff; font-size: 14px; text-decoration: none;">
                已有账号？立即登录
              </a>
            </div>
          </form>
          
          <div class="login-footer">
            国家公园智慧管理与生态保护系统 v1.0
          </div>
        </div>
      </div>
    </div>

    <script src="/web/assets/js/api.js"></script>
    <script>
      (function () {
        // 获取DOM元素
        var form = document.getElementById("registerForm");
        var phoneEl = document.getElementById("phone");
        var nameEl = document.getElementById("name");
        var passwordEl = document.getElementById("password");
        var roleTypeEl = document.getElementById("roleType");
        var errorEl = document.getElementById("error");
        var errorText = document.getElementById("errorText");
        var submitBtn = document.getElementById("submitBtn");

        // 显示错误提示
        function showError(msg) {
          errorText.textContent = msg || "注册失败";
          errorEl.style.display = "flex";
        }

        // 隐藏错误提示
        function hideError() {
          errorEl.style.display = "none";
        }

        // 设置按钮加载状态
        function setLoading(loading) {
          submitBtn.disabled = loading;
          submitBtn.textContent = loading ? "注册中..." : "完成注册";
        }

        // 表单提交事件
        form.addEventListener("submit", async function (e) {
          e.preventDefault();
          hideError();
          setLoading(true);

          try {
            // 构建请求参数
            var payload = {
              phone: (phoneEl.value || "").trim(),
              name: (nameEl.value || "").trim(),
              password: (passwordEl.value || "").trim(),
              role_type: roleTypeEl.value
            };

            // 基础校验
            if (!payload.phone) {
              showError("请输入手机号");
              setLoading(false);
              return;
            }
            if (!/^1[3-9]\d{9}$/.test(payload.phone)) {
              showError("请输入正确的手机号格式");
              setLoading(false);
              return;
            }
            if (!payload.name) {
              showError("请输入姓名");
              setLoading(false);
              return;
            }
            if (payload.name.length > 20) {
              showError("姓名长度不能超过20个字符");
              setLoading(false);
              return;
            }
            if (!payload.password) {
              showError("请输入密码");
              setLoading(false);
              return;
            }
            if (payload.password.length < 6) {
              showError("密码长度不能少于6位");
              setLoading(false);
              return;
            }
            if (!payload.role_type) {
              showError("请选择角色类型");
              setLoading(false);
              return;
            }

            // 调用注册接口
            var res = await Api.requestJson("POST", "/api/core/register", payload);
            
            // 接口响应校验
            if (!res || !res.success) {
              showError("注册失败，该手机号已被注册");
              setLoading(false);
              return;
            }
            
            // 注册成功，提示并跳转到登录页
            alert("注册成功！请使用手机号和密码登录");
            window.location.href = "/web/login.html";
          } catch (err) {
            // 捕获错误并显示
            showError(Api.formatError(err) || "注册失败，请稍后重试");
            setLoading(false);
          }
        });

        // 输入框聚焦时隐藏错误提示
        phoneEl.addEventListener("focus", hideError);
        nameEl.addEventListener("focus", hideError);
        passwordEl.addEventListener("focus", hideError);
        roleTypeEl.addEventListener("focus", hideError);
      })();
    </script>
  </body>
</html>